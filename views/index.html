<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="/build/xterm.css" />
<link rel="stylesheet" href="/build/addons/fullscreen/fullscreen.css" />
<link rel="stylesheet" href="style.css" />
<script src="/build/xterm.js"></script>
<script src="/build/addons/attach/attach.js"></script>
<script src="/build/addons/fit/fit.js"></script>
<script src="/build/addons/search/search.js"></script>
<script src="/build/addons/webLinks/webLinks.js"></script>
<script src="/build/addons/winptyCompat/winptyCompat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.1/es6-promise.auto.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"></script>

<script>
var ws = new WebSocket('ws://127.0.0.1:8000/ws');
var message = {
	nickname: "benben_2015",
	email: "123456@qq.com",
	content: "I love programming"
};
//添加状态判断，当为OPEN时，发送消息
console.log(ws.readyState);
//设置连接成功后的回调函数
ws.onopen=function () {
	console.log("socket has been opened");
	var message = {
		nickname: "benben_2015",
		email: "123456@qq.com",
		content: "I love programming"
	};
	message = JSON.stringify(message);
	ws.send(message);
};

window.onload=function(){
	var pods_name = "<%= pods_name %>".split(",");
	for(var i in pods_name){
		//console.log(pods_name[i]);
		var tr=document.getElementById("pods_tab").insertRow(-1);
		var num=tr.insertCell(0);
		var name=tr.insertCell(1);
		num.innerHTML = i;
		name.innerHTML = pods_name[i];
	}
	var term,
		protocol,
		socketURL,
		socket,
		pname;
	protocol = (location.protocol === 'https:') ? 'wss://' : 'ws://';
  	socketURL = protocol + location.hostname + ((location.port) ? (':' + location.port) : '') + '/kubectl/';
	term = new Terminal({});
	Terminal.applyAddon(attach);
	Terminal.applyAddon(fit);
	var terminalContainer = document.getElementById('terminal-container');
	term.open(terminalContainer);
	term.focus();
	
	setTimeout(function () {
		fetch('/kubectl?cols=' + term.cols + '&rows=' + term.rows, {method: 'POST'}).then(function (res) {
			res.text().then(function (pod_name) {
				pname = pod_name;
				socketURL += pname;
				socket = new WebSocket(socketURL);
				socket.onopen = runRealTerminal;
				console.log(socketURL)
			});
		});
	}, 0);
	function runRealTerminal() {
		term.attach(socket);
		term._initialized = true;
	}
}
   
</script>
</head>
<body>
		<%= helloWorld %>
	<table id="pods_tab">
		<caption>American Film Institute’s Top Five Films</caption>
		<thead>
			<tr>
				<th>序号
				<th>名称
			</tr>
		</thead>
		<tbody>
			
		</tbody>
	</table>
	<div id="terminal-container"></div>
</body>
</html>